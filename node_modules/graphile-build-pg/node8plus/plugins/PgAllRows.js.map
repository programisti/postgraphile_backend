{"version":3,"sources":["../../src/plugins/PgAllRows.js"],"names":["PgAllRows","builder","pgViewUniqueKey","pgSimpleCollections","subscriptions","hook","fields","build","context","parseResolveInfo","extend","getTypeByName","pgGetGqlTypeByTypeIdAndModifier","pgSql","sql","pgIntrospectionResultsByKind","introspectionResultsByKind","inflection","graphql","GraphQLList","GraphQLNonNull","pgQueryFromResolveData","queryFromResolveData","pgAddStartEndCursor","addStartEndCursor","pgOmit","omit","fieldWithHooks","scope","isRootQuery","class","reduce","memo","table","isSelectable","namespace","TableType","type","id","tableTypeName","name","ConnectionType","connection","Error","attributes","primaryKeyConstraint","primaryKeys","keyAttributes","isView","t","classKind","viewUniqueKey","tags","uniqueKey","uniqueIdAttribute","find","attr","undefined","namespaceName","schema","sqlFullTableName","identifier","makeField","isConnection","fieldName","allRows","allRowsSimple","getDataFromParsedResolveInfoFragment","description","args","resolve","parent","resolveContext","resolveInfo","pgClient","parsedResolveInfoFragment","resolveData","returnType","checkerGenerator","query","useAsterisk","canUseAsterisk","withPaginationAsFields","queryBuilder","makeLiveCollection","_checkerGenerator","selectIdentifiers","beforeLock","isOrderUnique","data","cursorPrefix","forEach","key","orderBy","fragment","getTableAlias","setOrderIsUnique","text","values","compile","debugSql","enabled","result","liveCollection","checker","rows","row","liveRecord","__identifiers","isPgFieldConnection","isPgFieldSimpleCollection","pgFieldIntrospection","simpleCollections","hasConnections","hasSimpleCollections"],"mappings":"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","file":"PgAllRows.js","sourcesContent":["// @flow\n\nimport type { Plugin } from \"graphile-build\";\nimport debugSql from \"./debugSql\";\n\nexport default (async function PgAllRows(\n  builder,\n  { pgViewUniqueKey, pgSimpleCollections, subscriptions }\n) {\n  builder.hook(\n    \"GraphQLObjectType:fields\",\n    (fields, build, context) => {\n      const {\n        parseResolveInfo,\n        extend,\n        getTypeByName,\n        pgGetGqlTypeByTypeIdAndModifier,\n        pgSql: sql,\n        pgIntrospectionResultsByKind: introspectionResultsByKind,\n        inflection,\n        graphql: { GraphQLList, GraphQLNonNull },\n        pgQueryFromResolveData: queryFromResolveData,\n        pgAddStartEndCursor: addStartEndCursor,\n        pgOmit: omit,\n      } = build;\n      const {\n        fieldWithHooks,\n        scope: { isRootQuery },\n      } = context;\n      if (!isRootQuery) {\n        return fields;\n      }\n      return extend(\n        fields,\n        introspectionResultsByKind.class.reduce((memo, table) => {\n          // PERFORMANCE: These used to be .filter(...) calls\n          if (!table.isSelectable) return memo;\n          if (!table.namespace) return memo;\n          if (omit(table, \"all\")) return memo;\n\n          const TableType = pgGetGqlTypeByTypeIdAndModifier(\n            table.type.id,\n            null\n          );\n          if (!TableType) {\n            return memo;\n          }\n          const tableTypeName = TableType.name;\n          const ConnectionType = getTypeByName(\n            inflection.connection(TableType.name)\n          );\n          if (!TableType) {\n            throw new Error(\n              `Could not find GraphQL type for table '${table.name}'`\n            );\n          }\n          const attributes = table.attributes;\n          const primaryKeyConstraint = table.primaryKeyConstraint;\n          const primaryKeys =\n            primaryKeyConstraint && primaryKeyConstraint.keyAttributes;\n          const isView = t => t.classKind === \"v\";\n          const viewUniqueKey = table.tags.uniqueKey || pgViewUniqueKey;\n          const uniqueIdAttribute = viewUniqueKey\n            ? attributes.find(attr => attr.name === viewUniqueKey)\n            : undefined;\n          if (isView && table.tags.uniqueKey && !uniqueIdAttribute) {\n            throw new Error(\n              `Could not find the named unique key '${\n                table.tags.uniqueKey\n              }' on view '${table.namespaceName}.${table.name}'`\n            );\n          }\n          if (!ConnectionType) {\n            throw new Error(\n              `Could not find GraphQL connection type for table '${table.name}'`\n            );\n          }\n          const schema = table.namespace;\n          const sqlFullTableName = sql.identifier(schema.name, table.name);\n          function makeField(isConnection) {\n            const fieldName = isConnection\n              ? inflection.allRows(table)\n              : inflection.allRowsSimple(table);\n            memo[fieldName] = fieldWithHooks(\n              fieldName,\n              ({ getDataFromParsedResolveInfoFragment }) => {\n                return {\n                  description: isConnection\n                    ? `Reads and enables pagination through a set of \\`${tableTypeName}\\`.`\n                    : `Reads a set of \\`${tableTypeName}\\`.`,\n                  type: isConnection\n                    ? ConnectionType\n                    : new GraphQLList(new GraphQLNonNull(TableType)),\n                  args: {},\n                  async resolve(parent, args, resolveContext, resolveInfo) {\n                    const { pgClient } = resolveContext;\n                    const parsedResolveInfoFragment = parseResolveInfo(\n                      resolveInfo\n                    );\n                    parsedResolveInfoFragment.args = args; // Allow overriding via makeWrapResolversPlugin\n                    const resolveData = getDataFromParsedResolveInfoFragment(\n                      parsedResolveInfoFragment,\n                      resolveInfo.returnType\n                    );\n                    let checkerGenerator;\n                    const query = queryFromResolveData(\n                      sqlFullTableName,\n                      undefined,\n                      resolveData,\n                      {\n                        useAsterisk: table.canUseAsterisk,\n                        withPaginationAsFields: isConnection,\n                      },\n                      queryBuilder => {\n                        if (subscriptions) {\n                          queryBuilder.makeLiveCollection(\n                            table,\n                            _checkerGenerator => {\n                              checkerGenerator = _checkerGenerator;\n                            }\n                          );\n                        }\n                        if (primaryKeys) {\n                          if (subscriptions && !isConnection) {\n                            queryBuilder.selectIdentifiers(table);\n                          }\n                          queryBuilder.beforeLock(\"orderBy\", () => {\n                            if (!queryBuilder.isOrderUnique(false)) {\n                              // Order by PK if no order specified\n                              queryBuilder.data.cursorPrefix = [\n                                \"primary_key_asc\",\n                              ];\n                              primaryKeys.forEach(key => {\n                                queryBuilder.orderBy(\n                                  sql.fragment`${queryBuilder.getTableAlias()}.${sql.identifier(\n                                    key.name\n                                  )}`,\n                                  true\n                                );\n                              });\n                              queryBuilder.setOrderIsUnique();\n                            }\n                          });\n                        } else if (isView(table) && !!uniqueIdAttribute) {\n                          queryBuilder.beforeLock(\"orderBy\", () => {\n                            if (!queryBuilder.isOrderUnique(false)) {\n                              queryBuilder.data.cursorPrefix = [\n                                \"view_unique_key_asc\",\n                              ];\n                              queryBuilder.orderBy(\n                                sql.fragment`${queryBuilder.getTableAlias()}.${sql.identifier(\n                                  uniqueIdAttribute.name\n                                )}`,\n                                true\n                              );\n                              queryBuilder.setOrderIsUnique();\n                            }\n                          });\n                        }\n                      },\n                      resolveContext\n                    );\n                    const { text, values } = sql.compile(query);\n                    if (debugSql.enabled) debugSql(text);\n                    const result = await pgClient.query(text, values);\n\n                    if (\n                      subscriptions &&\n                      resolveContext.liveCollection &&\n                      checkerGenerator\n                    ) {\n                      const checker = checkerGenerator();\n                      resolveContext.liveCollection(\"pg\", table, checker);\n                    }\n\n                    if (isConnection) {\n                      const {\n                        rows: [row],\n                      } = result;\n                      return addStartEndCursor(row);\n                    } else {\n                      if (\n                        subscriptions &&\n                        !isConnection &&\n                        primaryKeys &&\n                        resolveContext.liveRecord\n                      ) {\n                        result.rows.forEach(\n                          row =>\n                            row &&\n                            resolveContext.liveRecord(\n                              \"pg\",\n                              table,\n                              row.__identifiers\n                            )\n                        );\n                      }\n                      return result.rows;\n                    }\n                  },\n                };\n              },\n              {\n                isPgFieldConnection: isConnection,\n                isPgFieldSimpleCollection: !isConnection,\n                pgFieldIntrospection: table,\n              }\n            );\n          }\n          const simpleCollections =\n            table.tags.simpleCollections || pgSimpleCollections;\n          const hasConnections = simpleCollections !== \"only\";\n          const hasSimpleCollections =\n            simpleCollections === \"only\" || simpleCollections === \"both\";\n          if (TableType && ConnectionType && hasConnections) {\n            makeField(true);\n          }\n          if (TableType && hasSimpleCollections) {\n            makeField(false);\n          }\n          return memo;\n        }, {}),\n        `Adding 'all*' relations to root Query`\n      );\n    },\n    [\"PgAllRows\"],\n    [],\n    [\"PgTables\"]\n  );\n}: Plugin);\n"]}