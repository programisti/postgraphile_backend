{"version":3,"sources":["../src/QueryBuilder.js"],"names":["sql","isDev","process","env","POSTGRAPHILE_ENV","callIfNecessary","o","context","callIfNecessaryArray","Array","isArray","map","v","QueryBuilder","constructor","options","rootValue","supportsJSONB","locks","finalized","selectedIdentifiers","data","cursorPrefix","select","selectCursor","from","join","where","whereBound","lower","upper","orderBy","orderIsUnique","limit","offset","first","last","beforeLock","cursorComparator","liveConditions","compiledData","lock","jsonbBuildObject","fields","length","fieldsChunks","chunkToJson","fieldsChunk","fragment","expr","alias","literal","field","fn","checkLock","push","makeLiveCollection","table","cb","checkerGenerator","checkers","record","every","checker","parentQueryBuilder","Error","id","allRequirements","reduce","memo","_checkerGenerator","requirements","Object","assign","value","keys","key","addLiveCondition","setCursorComparator","addCursorCondition","cursorValue","isAfter","exprGen","test","selectIdentifiers","primaryKey","primaryKeyConstraint","primaryKeys","keyAttributes","getTableAlias","identifier","name","Symbol","isLower","setOrderIsUnique","ascending","nullsFirst","limitGen","offsetGen","previous","isOrderUnique","getTableExpression","getSelectCursor","getOffset","getFinalLimitAndOffset","flip","Math","min","getFinalOffset","getFinalLimit","getOrderByExpressionsAndDirections","getSelectFieldsCount","lockEverything","buildSelectFields","sqlFragment","buildSelectJson","addNullCase","buildObject","buildWhereBoundClause","clauses","buildWhereClause","includeLowerBound","includeUpperBound","build","asJson","asJsonAggregate","onlyJsonField","useAsterisk","Number","flipAlias","aggAlias","_finalize","type","getContext","queryBuilder","beforeLocks","stack","seenFields","selects","i","valueOrGenerator","columnName","newBeforeLocks","a","b","c","f","replace"],"mappings":";;;;;;AACA;;IAAYA,G;;AAEZ;;;;AACA;;;;;;;;AAGA;AAGA,MAAMC,QAAQC,QAAQC,GAAR,CAAYC,gBAAZ,KAAiC,aAA/C;;;AAOA,SAASC,eAAT,CAA4BC,CAA5B,EAA2CC,OAA3C,EAAmE;AACjE,MAAI,OAAOD,CAAP,KAAa,UAAjB,EAA6B;AAC3B,WAAOA,EAAEC,OAAF,CAAP;AACD,GAFD,MAEO;AACL,WAAOD,CAAP;AACD;AACF;;AAED,SAASE,oBAAT,CACEF,CADF,EAEEC,OAFF,EAGY;AACV,MAAIE,MAAMC,OAAN,CAAcJ,CAAd,CAAJ,EAAsB;AACpB,WAAOA,EAAEK,GAAF,CAAMC,KAAKP,gBAAgBO,CAAhB,EAAmBL,OAAnB,CAAX,CAAP;AACD,GAFD,MAEO;AACL,WAAOD,CAAP;AACD;AACF;;AAaD,MAAMO,YAAN,CAAmB;AAGD;AAqDhBC,cACEC,UAA+B,EADjC,EAEER,UAA0B,EAF5B,EAGES,SAHF,CAGkB;AAHlB,IAIE;AACA,SAAKT,OAAL,GAAeA,WAAW,EAA1B;AACA,SAAKS,SAAL,GAAiBA,SAAjB;AACA,SAAKC,aAAL,GACE,OAAOF,QAAQE,aAAf,KAAiC,WAAjC,IACAF,QAAQE,aAAR,KAA0B,IAD1B,GAEI,IAFJ,GAGI,CAAC,CAACF,QAAQE,aAJhB;;AAMA,SAAKC,KAAL,GAAa,EAAb;AACA,SAAKC,SAAL,GAAiB,KAAjB;AACA,SAAKC,mBAAL,GAA2B,KAA3B;AACA,SAAKC,IAAL,GAAY;AACV;AACAC,oBAAc,CAAC,SAAD,CAFJ;AAGVC,cAAQ,EAHE;AAIVC,oBAAc,IAJJ;AAKVC,YAAM,IALI;AAMVC,YAAM,EANI;AAOVC,aAAO,EAPG;AAQVC,kBAAY;AACVC,eAAO,EADG;AAEVC,eAAO;AAFG,OARF;AAYVC,eAAS,EAZC;AAaVC,qBAAe,KAbL;AAcVC,aAAO,IAdG;AAeVC,cAAQ,IAfE;AAgBVC,aAAO,IAhBG;AAiBVC,YAAM,IAjBI;AAkBVC,kBAAY,EAlBF;AAmBVC,wBAAkB,IAnBR;AAoBVC,sBAAgB;AApBN,KAAZ;AAsBA,SAAKC,YAAL,GAAoB;AAClBlB,oBAAc,CAAC,SAAD,CADI;AAElBC,cAAQ,EAFU;AAGlBC,oBAAc,IAHI;AAIlBC,YAAM,IAJY;AAKlBC,YAAM,EALY;AAMlBC,aAAO,EANW;AAOlBC,kBAAY;AACVC,eAAO,EADG;AAEVC,eAAO;AAFG,OAPM;AAWlBC,eAAS,EAXS;AAYlBC,qBAAe,KAZG;AAalBC,aAAO,IAbW;AAclBC,cAAQ,IAdU;AAelBC,aAAO,IAfW;AAgBlBC,YAAM,IAhBY;AAiBlBE,wBAAkB;AAjBA,KAApB;AAmBA,SAAKD,UAAL,CAAgB,QAAhB,EAA0B,MAAM;AAC9B,WAAKI,IAAL,CAAU,cAAV;AACA,UAAI,KAAKD,YAAL,CAAkBhB,YAAtB,EAAoC;AAClC,aAAKD,MAAL,CAAY,KAAKiB,YAAL,CAAkBhB,YAA9B,EAA4C,UAA5C;AACD;AACF,KALD;AAMA;AACA,SAAKa,UAAL,CAAgB,OAAhB,EAAyB,MAAM;AAC7B,WAAKI,IAAL,CAAU,YAAV;AACD,KAFD;AAGA,SAAKJ,UAAL,CAAgB,QAAhB,EAA0B,MAAM;AAC9B,WAAKI,IAAL,CAAU,YAAV;AACD,KAFD;AAGA,SAAKJ,UAAL,CAAgB,OAAhB,EAAyB,MAAM;AAC7B,WAAKI,IAAL,CAAU,YAAV;AACD,KAFD;AAGA,SAAKJ,UAAL,CAAgB,OAAhB,EAAyB,MAAM;AAC7B,WAAKI,IAAL,CAAU,OAAV;AACA,WAAKA,IAAL,CAAU,QAAV;AACD,KAHD;AAIA,SAAKJ,UAAL,CAAgB,MAAhB,EAAwB,MAAM;AAC5B,WAAKI,IAAL,CAAU,OAAV;AACA,WAAKA,IAAL,CAAU,QAAV;AACD,KAHD;AAID;;AAED;;AAEA;AACAC,mBAAiBC,MAAjB,EAAiD;AAC/C,QAAI,KAAK1B,aAAL,IAAsB0B,OAAOC,MAAP,GAAgB,EAA1C,EAA8C;AAC5C,YAAMC,eAAe,qBAAMF,MAAN,EAAc,EAAd,CAArB;AACA,YAAMG,cAAcC,eAClB/C,IAAIgD,QAAS,sBAAqBhD,IAAI0B,IAAJ,CAChCqB,YAAYpC,GAAZ,CACE,CAAC,CAACsC,IAAD,EAAOC,KAAP,CAAD,KACElD,IAAIgD,QAAS,GAAEhD,IAAImD,OAAJ,CAAYD,KAAZ,CAAmB,WAAUD,IAAK,EAFrD,CADgC,EAKhC,IALgC,CAMhC,GAPJ;AAQA,aAAOjD,IAAIgD,QAAS,IAAGhD,IAAI0B,IAAJ,CACrBmB,aAAalC,GAAb,CAAiBmC,WAAjB,CADqB,EAErB,MAFqB,CAGrB,SAHF;AAID,KAdD,MAcO;AACL;AACA,aAAO9C,IAAIgD,QAAS,qBAAoBhD,IAAI0B,IAAJ,CACtCiB,OAAOhC,GAAP,CACE,CAAC,CAACsC,IAAD,EAAOC,KAAP,CAAD,KAAmBlD,IAAIgD,QAAS,GAAEhD,IAAImD,OAAJ,CAAYD,KAAZ,CAAmB,WAAUD,IAAK,EADtE,CADsC,EAItC,IAJsC,CAKtC,GALF;AAMD;AACF;;AAED;;AAEAZ,aAAWe,KAAX,EAA0BC,EAA1B,EAA0C;AACxC,SAAKC,SAAL,CAAeF,KAAf;AACA,QAAI,CAAC,KAAK/B,IAAL,CAAUgB,UAAV,CAAqBe,KAArB,CAAL,EAAkC;AAChC,WAAK/B,IAAL,CAAUgB,UAAV,CAAqBe,KAArB,IAA8B,EAA9B;AACD;AACD;AACA,SAAK/B,IAAL,CAAUgB,UAAV,CAAqBe,KAArB,EAA4BG,IAA5B,CAAiCF,EAAjC;AACD;;AAEDG,qBACEC,KADF;AAEE;AACAC,IAHF,EAIE;AACA;AACA,QAAI,CAAC,KAAK1C,SAAN,IAAmB,CAAC,KAAKA,SAAL,CAAeuB,cAAvC,EAAuD;AACvD,UAAMA,iBAAiB,KAAKlB,IAAL,CAAUkB,cAAjC;AACA,UAAMoB,mBAAmBtC,QAAQ;AAC/B;AACA,YAAMuC,WAAWrB,eAAe5B,GAAf,CAAmB,CAAC,CAACgD,gBAAD,CAAD,KAClCA,iBAAiBtC,IAAjB,CADe,CAAjB;AAGA,aAAOwC,UAAUD,SAASE,KAAT,CAAeC,WAAWA,QAAQF,MAAR,CAA1B,CAAjB;AACD,KAND;AAOA,QAAI,KAAKG,kBAAT,EAA6B;AAC3B,UAAIN,EAAJ,EAAQ;AACN,cAAM,IAAIO,KAAJ,CACJ,2DADI,CAAN;AAGD;AACD,WAAKD,kBAAL,CAAwB3B,UAAxB,CAAmC,QAAnC,EAA6C,MAAM;AACjD,cAAM6B,KAAK,KAAKlD,SAAL,CAAeuB,cAAf,CAA8BgB,IAA9B,CAAmCI,gBAAnC,IAAuD,CAAlE;AACA;AACA,cAAMQ,kBAAkB,KAAK9C,IAAL,CAAUkB,cAAV,CAAyB6B,MAAzB,CACtB,CAACC,IAAD,EAAO,CAACC,iBAAD,EAAoBC,YAApB,CAAP,KACEA,eAAeC,OAAOC,MAAP,CAAcJ,IAAd,EAAoBE,YAApB,CAAf,GAAmDF,IAF/B,EAGtB,EAHsB,CAAxB;AAKA;AACA,aAAKL,kBAAL,CAAwBzC,MAAxB,CACEvB,IAAIgD,QAAS;oBACHhD,IAAI0E,KAAJ,CAAUR,EAAV,CAAc;YACtBlE,IAAI0B,IAAJ,CACA8C,OAAOG,IAAP,CAAYR,eAAZ,EAA6BxD,GAA7B,CACEiE,OACE5E,IAAIgD,QAAS,KAAIhD,IAAImD,OAAJ,CAAYyB,GAAZ,CAAiB,WAChCT,gBAAgBS,GAAhB,CACD,EAJL,CADA,EAQA,IARA,CASA;YAZJ,EAcE,QAdF;AAgBD,OAzBD;AA0BD,KAhCD,MAgCO,IAAIlB,EAAJ,EAAQ;AACbA,SAAGC,gBAAH;AACD,KAFM,MAEA;AACL,YAAM,IAAIM,KAAJ,CACJ,+EADI,CAAN;AAGD;AACF;;AAEDY;AACE;AACAlB,kBAFF,EAGEY,YAHF,EAIE;AACA,QAAIA,gBAAgB,CAAC,KAAKP,kBAA1B,EAA8C;AAC5C,YAAM,IAAIC,KAAJ,CACJ,gEADI,CAAN;AAGD;AACD,SAAK5C,IAAL,CAAUkB,cAAV,CAAyBgB,IAAzB,CAA8B,CAACI,gBAAD,EAAmBY,YAAnB,CAA9B;AACD;;AAEDO,sBAAoBzB,EAApB,EAA0C;AACxC,SAAKC,SAAL,CAAe,kBAAf;AACA,SAAKjC,IAAL,CAAUiB,gBAAV,GAA6Be,EAA7B;AACA,SAAKZ,IAAL,CAAU,kBAAV;AACD;AACDsC,qBAAmBC,WAAnB,EAA6CC,OAA7C,EAA+D;AAC7D,SAAK5C,UAAL,CAAgB,YAAhB,EAA8B,MAAM;AAClC,WAAKI,IAAL,CAAU,kBAAV;AACA,UAAI,CAAC,KAAKD,YAAL,CAAkBF,gBAAvB,EAAyC;AACvC,cAAM,IAAI2B,KAAJ,CAAU,+BAAV,CAAN;AACD;AACD,WAAKzB,YAAL,CAAkBF,gBAAlB,CAAmC0C,WAAnC,EAAgDC,OAAhD;AACD,KAND;AAOD;AACD1D,SAAO2D,OAAP,EAAwBhC,KAAxB,EAAyC;AACvC,SAAKI,SAAL,CAAe,QAAf;AACA,QAAI,OAAOJ,KAAP,KAAiB,QAArB,EAA+B;AAC7B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAI,oCAAoCiC,IAApC,CAAyCjC,KAAzC,MAAoD,IAAxD,EAA8D;AAC5D,cAAM,IAAIe,KAAJ,CAAW,qBAAoBf,KAAM,IAArC,CAAN;AACD;AACF;AACD,SAAK7B,IAAL,CAAUE,MAAV,CAAiBgC,IAAjB,CAAsB,CAAC2B,OAAD,EAAUhC,KAAV,CAAtB;AACD;AACDkC,oBAAkB3B,KAAlB,EAAkC;AAChC,QAAI,KAAKrC,mBAAT,EAA8B;AAC9B,UAAMiE,aAAa5B,MAAM6B,oBAAzB;AACA,QAAI,CAACD,UAAL,EAAiB;AACjB,UAAME,cAAcF,WAAWG,aAA/B;AACA,SAAKjE,MAAL,CACEvB,IAAIgD,QAAS,oBAAmBhD,IAAI0B,IAAJ,CAC9B6D,YAAY5E,GAAZ,CACEiE,OACE5E,IAAIgD,QAAS,GAAE,KAAKyC,aAAL,EAAqB,IAAGzF,IAAI0F,UAAJ,CAAed,IAAIe,IAAnB,CAAyB,EAFpE,CAD8B,EAK9B,IAL8B,CAM9B,GAPJ,EAQE,eARF;AAUA,SAAKvE,mBAAL,GAA2B,IAA3B;AACD;AACDI,eAAa0D,OAAb,EAA8B;AAC5B,SAAK5B,SAAL,CAAe,cAAf;AACA,SAAKjC,IAAL,CAAUG,YAAV,GAAyB0D,OAAzB;AACD;AACDzD,OAAKwB,IAAL,EAAmBC,QAAmBlD,IAAI0F,UAAJ,CAAeE,QAAf,CAAtC,EAAgE;AAC9D,SAAKtC,SAAL,CAAe,MAAf;AACA,QAAI,CAACL,IAAL,EAAW;AACT,YAAM,IAAIgB,KAAJ,CAAU,uBAAV,CAAN;AACD;AACD,QAAI,CAACf,KAAL,EAAY;AACV,YAAM,IAAIe,KAAJ,CAAU,gBAAV,CAAN;AACD;AACD,SAAK5C,IAAL,CAAUI,IAAV,GAAiB,CAACwB,IAAD,EAAOC,KAAP,CAAjB;AACA,SAAKT,IAAL,CAAU,MAAV;AACD;AACD;AACAd,QAAMuD,OAAN,EAAuB;AACrB,SAAK5B,SAAL,CAAe,OAAf;AACA,SAAKjC,IAAL,CAAUM,KAAV,CAAgB4B,IAAhB,CAAqB2B,OAArB;AACD;AACDtD,aAAWsD,OAAX,EAA4BW,OAA5B,EAA8C;AAC5C,QAAI,OAAOA,OAAP,KAAmB,SAAvB,EAAkC;AAChC,YAAM,IAAI5B,KAAJ,CAAU,wCAAV,CAAN;AACD;AACD,SAAKX,SAAL,CAAe,YAAf;AACA,SAAKjC,IAAL,CAAUO,UAAV,CAAqBiE,UAAU,OAAV,GAAoB,OAAzC,EAAkDtC,IAAlD,CAAuD2B,OAAvD;AACD;AACDY,qBAAmB;AACjB,SAAKzE,IAAL,CAAUW,aAAV,GAA0B,IAA1B;AACD;AACDD,UACEmD,OADF,EAEEa,YAAqB,IAFvB,EAGEC,UAHF,EAIE;AACA,SAAK1C,SAAL,CAAe,SAAf;AACA,SAAKjC,IAAL,CAAUU,OAAV,CAAkBwB,IAAlB,CAAuB,CAAC2B,OAAD,EAAUa,SAAV,EAAqBC,UAArB,CAAvB;AACD;AACD/D,QAAMgE,QAAN,EAA2B;AACzB,SAAK3C,SAAL,CAAe,OAAf;;AAEA,QAAI,KAAKjC,IAAL,CAAUY,KAAV,IAAmB,IAAvB,EAA6B;AAC3B,YAAM,IAAIgC,KAAJ,CAAU,0BAAV,CAAN;AACD;AACD,SAAK5C,IAAL,CAAUY,KAAV,GAAkBgE,QAAlB;AACD;AACD/D,SAAOgE,SAAP,EAA6B;AAC3B,SAAK5C,SAAL,CAAe,QAAf;AACA,QAAI,KAAKjC,IAAL,CAAUa,MAAV,IAAoB,IAAxB,EAA8B;AAC5B;AACA,YAAMiE,WAAW,KAAK9E,IAAL,CAAUa,MAA3B;AACA,WAAKb,IAAL,CAAUa,MAAV,GAAmB3B,WAAW;AAC5B,eACEF,gBAAgB8F,QAAhB,EAA0B5F,OAA1B,IACAF,gBAAgB6F,SAAhB,EAA2B3F,OAA3B,CAFF;AAID,OALD;AAMD,KATD,MASO;AACL,WAAKc,IAAL,CAAUa,MAAV,GAAmBgE,SAAnB;AACD;AACF;AACD/D,QAAMA,KAAN,EAAqB;AACnB,SAAKmB,SAAL,CAAe,OAAf;AACA,QAAI,KAAKjC,IAAL,CAAUc,KAAV,IAAmB,IAAvB,EAA6B;AAC3B,YAAM,IAAI8B,KAAJ,CAAU,0BAAV,CAAN;AACD;AACD,SAAK5C,IAAL,CAAUc,KAAV,GAAkBA,KAAlB;AACD;AACDC,OAAKA,IAAL,EAAmB;AACjB,SAAKkB,SAAL,CAAe,MAAf;AACA,QAAI,KAAKjC,IAAL,CAAUe,IAAV,IAAkB,IAAtB,EAA4B;AAC1B,YAAM,IAAI6B,KAAJ,CAAU,yBAAV,CAAN;AACD;AACD,SAAK5C,IAAL,CAAUe,IAAV,GAAiBA,IAAjB;AACD;;AAED;;AAEAgE,gBAAc3D,OAAiB,IAA/B,EAAqC;AACnC,QAAIA,IAAJ,EAAU;AACR,WAAKA,IAAL,CAAU,SAAV;AACA,WAAKA,IAAL,CAAU,eAAV;AACA,aAAO,KAAKD,YAAL,CAAkBR,aAAzB;AACD,KAJD,MAIO;AACL;AACA,aAAO,KAAKX,IAAL,CAAUW,aAAjB;AACD;AACF;AACDqE,uBAA0B;AACxB,SAAK5D,IAAL,CAAU,MAAV;AACA,QAAI,CAAC,KAAKD,YAAL,CAAkBf,IAAvB,EAA6B;AAC3B,YAAM,IAAIwC,KAAJ,CAAU,iCAAV,CAAN;AACD;AACD,WAAO,KAAKzB,YAAL,CAAkBf,IAAlB,CAAuB,CAAvB,CAAP;AACD;AACDgE,kBAAqB;AACnB,SAAKhD,IAAL,CAAU,MAAV;AACA,QAAI,CAAC,KAAKD,YAAL,CAAkBf,IAAvB,EAA6B;AAC3B,YAAM,IAAIwC,KAAJ,CAAU,iCAAV,CAAN;AACD;AACD,WAAO,KAAKzB,YAAL,CAAkBf,IAAlB,CAAuB,CAAvB,CAAP;AACD;AACD6E,oBAAkB;AAChB,SAAK7D,IAAL,CAAU,cAAV;AACA,WAAO,KAAKD,YAAL,CAAkBhB,YAAzB;AACD;AACD+E,cAAY;AACV,SAAK9D,IAAL,CAAU,QAAV;AACA,WAAO,KAAKD,YAAL,CAAkBN,MAAlB,IAA4B,CAAnC;AACD;AACDsE,2BAAyB;AACvB,SAAK/D,IAAL,CAAU,QAAV;AACA,SAAKA,IAAL,CAAU,OAAV;AACA,SAAKA,IAAL,CAAU,OAAV;AACA,SAAKA,IAAL,CAAU,MAAV;AACA,QAAIR,QAAQ,KAAKO,YAAL,CAAkBP,KAA9B;AACA,QAAIC,SAAS,KAAKM,YAAL,CAAkBN,MAAlB,IAA4B,CAAzC;AACA,QAAIuE,OAAO,KAAX;AACA,QAAI,KAAKjE,YAAL,CAAkBL,KAAlB,IAA2B,IAA/B,EAAqC;AACnC,UAAIF,SAAS,IAAb,EAAmB;AACjBA,gBAAQyE,KAAKC,GAAL,CAAS1E,KAAT,EAAgB,KAAKO,YAAL,CAAkBL,KAAlC,CAAR;AACD,OAFD,MAEO;AACLF,gBAAQ,KAAKO,YAAL,CAAkBL,KAA1B;AACD;AACF;AACD,QAAI,KAAKK,YAAL,CAAkBJ,IAAlB,IAA0B,IAA9B,EAAoC;AAClC,UAAIF,SAAS,CAAT,IAAcD,SAAS,IAA3B,EAAiC;AAC/B,cAAM,IAAIgC,KAAJ,CACJ,qEADI,CAAN;AAGD;AACD,UAAIhC,SAAS,IAAb,EAAmB;AACjB,YAAI,KAAKO,YAAL,CAAkBJ,IAAlB,GAAyBH,KAA7B,EAAoC;AAClCC,mBAASD,QAAQ,KAAKO,YAAL,CAAkBJ,IAAnC;AACAH,kBAAQ,KAAKO,YAAL,CAAkBJ,IAA1B;AACD,SAHD,MAGO;AACL;AACD;AACF,OAPD,MAOO,IAAIF,SAAS,CAAb,EAAgB;AACrB,cAAM,IAAI+B,KAAJ,CAAU,oCAAV,CAAN;AACD,OAFM,MAEA;AACL,YAAI,KAAKzB,YAAL,CAAkBT,OAAlB,CAA0Ba,MAA1B,GAAmC,CAAvC,EAA0C;AACxC6D,iBAAO,IAAP;AACAxE,kBAAQ,KAAKO,YAAL,CAAkBJ,IAA1B;AACD,SAHD,MAGO;AACL,gBAAM,IAAI6B,KAAJ,CAAU,oCAAV,CAAN;AACD;AACF;AACF;AACD,WAAO;AACLhC,WADK;AAELC,YAFK;AAGLuE;AAHK,KAAP;AAKD;AACDG,mBAAiB;AACf,WAAO,KAAKJ,sBAAL,GAA8BtE,MAArC;AACD;AACD2E,kBAAgB;AACd,WAAO,KAAKL,sBAAL,GAA8BvE,KAArC;AACD;AACD6E,uCAAqC;AACnC,SAAKrE,IAAL,CAAU,SAAV;AACA,WAAO,KAAKD,YAAL,CAAkBT,OAAzB;AACD;AACDgF,yBAAuB;AACrB,SAAKC,cAAL;AACA,WAAO,KAAKxE,YAAL,CAAkBjB,MAAlB,CAAyBqB,MAAhC;AACD;AACDqE,sBAAoB;AAClB,SAAKD,cAAL;AACA,WAAOhH,IAAI0B,IAAJ,CACL,KAAKc,YAAL,CAAkBjB,MAAlB,CAAyBZ,GAAzB,CACE,CAAC,CAACuG,WAAD,EAAchE,KAAd,CAAD,KACElD,IAAIgD,QAAS,WAAUkE,WAAY,QAAOlH,IAAI0F,UAAJ,CAAexC,KAAf,CAAsB,EAFpE,CADK,EAKL,IALK,CAAP;AAOD;AACDiE,kBAAgB,EAAEC,WAAF,EAAhB,EAA4D;AAC1D,SAAKJ,cAAL;AACA,QAAIK,cAAc,KAAK7E,YAAL,CAAkBjB,MAAlB,CAAyBqB,MAAzB,GACd,KAAKF,gBAAL,CAAsB,KAAKF,YAAL,CAAkBjB,MAAxC,CADc,GAEdvB,IAAIgD,QAAS,WAAU,KAAKyC,aAAL,EAAqB,GAFhD;AAGA,QAAI2B,WAAJ,EAAiB;AACfC,oBAAcrH,IAAIgD,QAAS,eAAc,KAAKyC,aAAL,EAAqB,4BAA2B4B,WAAY,OAArG;AACD;AACD,WAAOA,WAAP;AACD;AACDC,wBAAsBzB,OAAtB,EAAwC;AACtC,SAAKpD,IAAL,CAAU,YAAV;AACA,UAAM8E,UAAU,KAAK/E,YAAL,CAAkBZ,UAAlB,CAA6BiE,UAAU,OAAV,GAAoB,OAAjD,CAAhB;AACA,QAAI0B,QAAQ3E,MAAZ,EAAoB;AAClB,aAAO5C,IAAIgD,QAAS,IAAGhD,IAAI0B,IAAJ,CAAS6F,OAAT,EAAkB,SAAlB,CAA6B,GAApD;AACD,KAFD,MAEO;AACL,aAAOvH,IAAImD,OAAJ,CAAY,IAAZ,CAAP;AACD;AACF;AACDqE,mBACEC,iBADF,EAEEC,iBAFF,EAGE,EAAEN,WAAF,EAHF,EAIE;AACA,SAAK3E,IAAL,CAAU,OAAV;AACA,UAAM8E,UAAU,CACd,IAAIH,cACA;;;;;;;;;;;;;;;;;;AAkBA,KAACpH,IAAIgD,QAAS,QAAO,KAAKyC,aAAL,EAAqB,WAA1C,CAnBA,GAoBA,EApBJ,CADc,EAsBd,GAAG,KAAKjD,YAAL,CAAkBb,KAtBP,EAuBd,IAAI8F,oBAAoB,CAAC,KAAKH,qBAAL,CAA2B,IAA3B,CAAD,CAApB,GAAyD,EAA7D,CAvBc,EAwBd,IAAII,oBAAoB,CAAC,KAAKJ,qBAAL,CAA2B,KAA3B,CAAD,CAApB,GAA0D,EAA9D,CAxBc,CAAhB;AA0BA,WAAOC,QAAQ3E,MAAR,GACH5C,IAAIgD,QAAS,IAAGhD,IAAI0B,IAAJ,CAAS6F,OAAT,EAAkB,SAAlB,CAA6B,GAD1C,GAEHvH,IAAIgD,QAAS,OAFjB;AAGD;AACD2E,QACE5G,UAMI,EAPN,EAQE;AACA,UAAM;AACJ6G,eAAS,KADL;AAEJC,wBAAkB,KAFd;AAGJC,sBAAgB,KAHZ;AAIJV,oBAAc,KAJV;AAKJW,oBAAc;AALV,QAMFhH,OANJ;;AAQA,SAAKiG,cAAL;AACA,QAAIc,aAAJ,EAAmB;AACjB,aAAO,KAAKX,eAAL,CAAqB,EAAEC,WAAF,EAArB,CAAP;AACD;AACD,UAAM,EAAEnF,KAAF,EAASC,MAAT,EAAiBuE,IAAjB,KAA0B,KAAKD,sBAAL,EAAhC;AACA,UAAM7D,SACJiF,UAAUC,eAAV,GACI7H,IAAIgD,QAAS,GAAE,KAAKmE,eAAL,CAAqB,EAAEC,WAAF,EAArB,CAAsC,YADzD,GAEI,KAAKH,iBAAL,EAHN;;AAKA,QAAIjE,WAAWhD,IAAIgD,QAAS;eACjB+E,cAAc/H,IAAIgD,QAAS,GAAE,KAAKyC,aAAL,EAAqB,IAAlD,GAAwD9C,MAAO;QACtE,KAAKH,YAAL,CAAkBf,IAAlB,IACAzB,IAAIgD,QAAS,QACX,KAAKR,YAAL,CAAkBf,IAAlB,CAAuB,CAAvB,CACD,OAAM,KAAKgE,aAAL,EAAqB,EAAE;QAC9B,KAAKjD,YAAL,CAAkBd,IAAlB,CAAuBkB,MAAvB,IAAiC5C,IAAI0B,IAAJ,CAAS,KAAKc,YAAL,CAAkBd,IAA3B,EAAiC,GAAjC,CAAsC;cACjE,KAAK8F,gBAAL,CAAsB,IAAtB,EAA4B,IAA5B,EAAkCzG,OAAlC,CAA2C;QAEjD,KAAKyB,YAAL,CAAkBT,OAAlB,CAA0Ba,MAA1B,GACI5C,IAAIgD,QAAS,YAAWhD,IAAI0B,IAAJ,CACtB,KAAKc,YAAL,CAAkBT,OAAlB,CAA0BpB,GAA1B,CACE,CAAC,CAACsC,IAAD,EAAO8C,SAAP,EAAkBC,UAAlB,CAAD,KACEhG,IAAIgD,QAAS,GAAEC,IAAK,IAClB+E,OAAOjC,SAAP,IAAoBiC,OAAOvB,IAAP,CAApB,GACIzG,IAAIgD,QAAS,KADjB,GAEIhD,IAAIgD,QAAS,MAClB,GACCgD,eAAe,IAAf,GACIhG,IAAIgD,QAAS,cADjB,GAEIgD,eAAe,KAAf,GACEhG,IAAIgD,QAAS,aADf,GAEE,IACP,EAZL,CADsB,EAetB,GAfsB,CAgBtB,EAjBN,GAkBI,EACL;QACC,6BAAcf,KAAd,KAAwBjC,IAAIgD,QAAS,SAAQhD,IAAImD,OAAJ,CAAYlB,KAAZ,CAAmB,EAAE;QAClEC,UAAUlC,IAAIgD,QAAS,UAAShD,IAAImD,OAAJ,CAAYjB,MAAZ,CAAoB,EAAE;KA9B1D;AAgCA,QAAIuE,IAAJ,EAAU;AACR,YAAMwB,YAAYrC,QAAlB;AACA5C,iBAAWhD,IAAIgD,QAAS;eACfhD,IAAI0F,UAAJ,CAAeuC,SAAf,CAA0B;YAC7BjF,QAAS;;;eAGNhD,IAAI0F,UAAJ,CAAeuC,SAAf,CAA0B;;SALnC;AAQD;AACD,QAAIF,WAAJ,EAAiB;AACf/E,iBAAWhD,IAAIgD,QAAS,UAASL,MAAO,UAASK,QAAS,KAAI,KAAKyC,aAAL,EAAqB,EAAnF;AACD;AACD,QAAIoC,eAAJ,EAAqB;AACnB,YAAMK,WAAWtC,QAAjB;AACA5C,iBAAWhD,IAAIgD,QAAS,mBAAkBhD,IAAI0F,UAAJ,CACxCwC,QADwC,EAExC,QAFwC,CAGxC,WAAUlF,QAAS,QAAOhD,IAAI0F,UAAJ,CAAewC,QAAf,CAAyB,EAHrD;AAIAlF,iBAAWhD,IAAIgD,QAAS,oBAAmBA,QAAS,gBAApD;AACD;AACD,WAAOA,QAAP;AACD;;AAED;;AAEAmF,cAAY;AACV,SAAKhH,SAAL,GAAiB,IAAjB;AACD;AACDsB,OAAK2F,IAAL,EAAmB;AACjB,QAAI,KAAKlH,KAAL,CAAWkH,IAAX,CAAJ,EAAsB;AACtB,UAAMC,aAAa,OAAO;AACxBC,oBAAc;AADU,KAAP,CAAnB;AAGA,UAAMC,cAAc,KAAKlH,IAAL,CAAUgB,UAAV,CAAqB+F,IAArB,CAApB;AACA,QAAIG,eAAeA,YAAY3F,MAA/B,EAAuC;AACrC,WAAKvB,IAAL,CAAUgB,UAAV,CAAqB+F,IAArB,IAA6B,IAA7B;AACA,WAAK,MAAM/E,EAAX,IAAiBkF,WAAjB,EAA8B;AAC5BlF;AACD;AACF;AACD,QAAI+E,SAAS,QAAb,EAAuB;AACrB,WAAKlH,KAAL,CAAWkH,IAAX,IAAmBnI,QAAQ,IAAIgE,KAAJ,CAAU,sBAAV,EAAkCuE,KAA1C,GAAkD,IAArE;AACD;AACD,QAAIJ,SAAS,kBAAb,EAAiC;AAC/B;AACA,WAAK5F,YAAL,CAAkB4F,IAAlB,IAA0B,KAAK/G,IAAL,CAAU+G,IAAV,CAA1B;AACD,KAHD,MAGO,IAAIA,SAAS,YAAb,EAA2B;AAChC;AACA,YAAM7H,UAAU8H,YAAhB;AACA,WAAK7F,YAAL,CAAkB4F,IAAlB,EAAwBvG,KAAxB,GAAgCrB,qBAC9B,KAAKa,IAAL,CAAU+G,IAAV,EAAgBvG,KADc,EAE9BtB,OAF8B,CAAhC;AAIA,WAAKiC,YAAL,CAAkB4F,IAAlB,EAAwBtG,KAAxB,GAAgCtB,qBAC9B,KAAKa,IAAL,CAAU+G,IAAV,EAAgBtG,KADc,EAE9BvB,OAF8B,CAAhC;AAID,KAXM,MAWA,IAAI6H,SAAS,QAAb,EAAuB;AAC5B;;;;;;AAMA;AACA;AACA,YAAMK,aAAa,EAAnB;AACA,YAAMlI,UAAU8H,YAAhB;AACA,YAAMhH,OAAO,EAAb;AACA,YAAMqH,UAAU,KAAKrH,IAAL,CAAU+G,IAAV,CAAhB;;AAEA;AACA,WAAK,IAAIO,IAAI,CAAb,EAAgBA,IAAID,QAAQ9F,MAA5B,EAAoC+F,GAApC,EAAyC;AACvC,cAAM,CAACC,gBAAD,EAAmBC,UAAnB,IAAiCH,QAAQC,CAAR,CAAvC;AACA;AACA,YAAI,CAACF,WAAWI,UAAX,CAAL,EAA6B;AAC3B;AACAJ,qBAAWI,UAAX,IAAyB,IAAzB;AACAxH,eAAKkC,IAAL,CAAU,CAAClD,gBAAgBuI,gBAAhB,EAAkCrI,OAAlC,CAAD,EAA6CsI,UAA7C,CAAV;AACA,gBAAMC,iBAAiB,KAAKzH,IAAL,CAAUgB,UAAV,CAAqB+F,IAArB,CAAvB;AACA,cAAIU,kBAAkBA,eAAelG,MAArC,EAA6C;AAC3C,iBAAKvB,IAAL,CAAUgB,UAAV,CAAqB+F,IAArB,IAA6B,IAA7B;AACA,iBAAK,MAAM/E,EAAX,IAAiByF,cAAjB,EAAiC;AAC/BzF;AACD;AACF;AACF;AACF;AACD,WAAKnC,KAAL,CAAWkH,IAAX,IAAmBnI,QAAQ,IAAIgE,KAAJ,CAAU,sBAAV,EAAkCuE,KAA1C,GAAkD,IAArE;AACA,WAAKhG,YAAL,CAAkB4F,IAAlB,IAA0B/G,IAA1B;AACD,KAjCM,MAiCA,IAAI+G,SAAS,SAAb,EAAwB;AAC7B,YAAM7H,UAAU8H,YAAhB;AACA,WAAK7F,YAAL,CAAkB4F,IAAlB,IAA0B,KAAK/G,IAAL,CAAU+G,IAAV,EAAgBzH,GAAhB,CAAoB,CAAC,CAACoI,CAAD,EAAIC,CAAJ,EAAOC,CAAP,CAAD,KAAe,CAC3D5I,gBAAgB0I,CAAhB,EAAmBxI,OAAnB,CAD2D,EAE3DyI,CAF2D,EAG3DC,CAH2D,CAAnC,CAA1B;AAKD,KAPM,MAOA,IAAIb,SAAS,MAAb,EAAqB;AAC1B,UAAI,KAAK/G,IAAL,CAAUI,IAAd,EAAoB;AAClB,cAAMyH,IAAI,KAAK7H,IAAL,CAAUI,IAApB;AACA,cAAMlB,UAAU8H,YAAhB;AACA,aAAK7F,YAAL,CAAkBf,IAAlB,GAAyB,CAACpB,gBAAgB6I,EAAE,CAAF,CAAhB,EAAsB3I,OAAtB,CAAD,EAAiC2I,EAAE,CAAF,CAAjC,CAAzB;AACD;AACF,KANM,MAMA,IAAId,SAAS,MAAT,IAAmBA,SAAS,OAAhC,EAAyC;AAC9C,YAAM7H,UAAU8H,YAAhB;AACA,WAAK7F,YAAL,CAAkB4F,IAAlB,IAA0B5H,qBAAqB,KAAKa,IAAL,CAAU+G,IAAV,CAArB,EAAsC7H,OAAtC,CAA1B;AACD,KAHM,MAGA,IAAI6H,SAAS,cAAb,EAA6B;AAClC,YAAM7H,UAAU8H,YAAhB;AACA,WAAK7F,YAAL,CAAkB4F,IAAlB,IAA0B/H,gBAAgB,KAAKgB,IAAL,CAAU+G,IAAV,CAAhB,EAAiC7H,OAAjC,CAA1B;AACD,KAHM,MAGA,IAAI6H,SAAS,cAAb,EAA6B;AAClC,WAAK5F,YAAL,CAAkB4F,IAAlB,IAA0B,KAAK/G,IAAL,CAAU+G,IAAV,CAA1B;AACD,KAFM,MAEA,IAAIA,SAAS,eAAb,EAA8B;AACnC,WAAK5F,YAAL,CAAkB4F,IAAlB,IAA0B,KAAK/G,IAAL,CAAU+G,IAAV,CAA1B;AACD,KAFM,MAEA,IAAIA,SAAS,OAAb,EAAsB;AAC3B,YAAM7H,UAAU8H,YAAhB;AACA,WAAK7F,YAAL,CAAkB4F,IAAlB,IAA0B/H,gBAAgB,KAAKgB,IAAL,CAAU+G,IAAV,CAAhB,EAAiC7H,OAAjC,CAA1B;AACD,KAHM,MAGA,IAAI6H,SAAS,QAAb,EAAuB;AAC5B,YAAM7H,UAAU8H,YAAhB;AACA,WAAK7F,YAAL,CAAkB4F,IAAlB,IAA0B/H,gBAAgB,KAAKgB,IAAL,CAAU+G,IAAV,CAAhB,EAAiC7H,OAAjC,CAA1B;AACD,KAHM,MAGA,IAAI6H,SAAS,OAAb,EAAsB;AAC3B,WAAK5F,YAAL,CAAkB4F,IAAlB,IAA0B,KAAK/G,IAAL,CAAU+G,IAAV,CAA1B;AACD,KAFM,MAEA,IAAIA,SAAS,MAAb,EAAqB;AAC1B,WAAK5F,YAAL,CAAkB4F,IAAlB,IAA0B,KAAK/G,IAAL,CAAU+G,IAAV,CAA1B;AACD,KAFM,MAEA;AACL,YAAM,IAAInE,KAAJ,CAAW,6BAA4BmE,IAAK,GAA5C,CAAN;AACD;AACF;AACD9E,YAAU8E,IAAV,EAAwB;AACtB,QAAI,KAAKlH,KAAL,CAAWkH,IAAX,CAAJ,EAAsB;AACpB,UAAI,OAAO,KAAKlH,KAAL,CAAWkH,IAAX,CAAP,KAA4B,QAAhC,EAA0C;AACxC,cAAM,IAAInE,KAAJ,CACH,IAAGmE,IAAK,iCAAT,GACE,KAAKlH,KAAL,CAAWkH,IAAX,EAAiBe,OAAjB,CAAyB,KAAzB,EAAgC,QAAhC,CADF,GAEE,IAHE,CAAN;AAKD;AACD,YAAM,IAAIlF,KAAJ,CAAW,IAAGmE,IAAK,2BAAnB,CAAN;AACD;AACF;AACDpB,mBAAiB;AACf,SAAKmB,SAAL;AACA;AACA,SAAK1F,IAAL,CAAU,MAAV;AACA,SAAKA,IAAL,CAAU,MAAV;AACA,SAAKA,IAAL,CAAU,SAAV;AACA;AACA,SAAKA,IAAL,CAAU,kBAAV;AACA,SAAKA,IAAL,CAAU,YAAV;AACA,SAAKA,IAAL,CAAU,OAAV;AACA;AACA,SAAKA,IAAL,CAAU,QAAV;AACA,SAAKA,IAAL,CAAU,OAAV;AACA,SAAKA,IAAL,CAAU,OAAV;AACA,SAAKA,IAAL,CAAU,MAAV;AACA;AACA,SAAKA,IAAL,CAAU,cAAV;AACA,SAAKA,IAAL,CAAU,QAAV;AACD;AA9uBgB;;kBAivBJ5B,Y","file":"QueryBuilder.js","sourcesContent":["// @flow\nimport * as sql from \"pg-sql2\";\nimport type { SQL } from \"pg-sql2\";\nimport isSafeInteger from \"lodash/isSafeInteger\";\nimport chunk from \"lodash/chunk\";\nimport type { PgClass } from \"./plugins/PgIntrospectionPlugin\";\n\n// eslint-disable-next-line flowtype/no-weak-types\ntype GraphQLContext = any;\n\nconst isDev = process.env.POSTGRAPHILE_ENV === \"development\";\n\ntype GenContext = {\n  queryBuilder: QueryBuilder,\n};\ntype Gen<T> = (context: GenContext) => T;\n\nfunction callIfNecessary<T>(o: Gen<T> | T, context: GenContext): T {\n  if (typeof o === \"function\") {\n    return o(context);\n  } else {\n    return o;\n  }\n}\n\nfunction callIfNecessaryArray<T>(\n  o: Array<Gen<T> | T>,\n  context: GenContext\n): Array<T> {\n  if (Array.isArray(o)) {\n    return o.map(v => callIfNecessary(v, context));\n  } else {\n    return o;\n  }\n}\n\nexport type RawAlias = Symbol | string;\ntype SQLAlias = SQL;\ntype SQLGen = Gen<SQL> | SQL;\ntype NumberGen = Gen<number> | number;\ntype CursorValue = {};\ntype CursorComparator = (val: CursorValue, isAfter: boolean) => void;\n\nexport type QueryBuilderOptions = {\n  supportsJSONB?: boolean, // Defaults to true\n};\n\nclass QueryBuilder {\n  parentQueryBuilder: QueryBuilder | void;\n  context: GraphQLContext;\n  rootValue: any; // eslint-disable-line flowtype/no-weak-types\n  supportsJSONB: boolean;\n  locks: {\n    [string]: true | string,\n  };\n  finalized: boolean;\n  selectedIdentifiers: boolean;\n  data: {\n    cursorPrefix: Array<string>,\n    select: Array<[SQLGen, RawAlias]>,\n    selectCursor: ?SQLGen,\n    from: ?[SQLGen, SQLAlias],\n    join: Array<SQLGen>,\n    where: Array<SQLGen>,\n    whereBound: {\n      lower: Array<SQLGen>,\n      upper: Array<SQLGen>,\n    },\n    orderBy: Array<[SQLGen, boolean, boolean | null]>,\n    orderIsUnique: boolean,\n    limit: ?NumberGen,\n    offset: ?NumberGen,\n    first: ?number,\n    last: ?number,\n    beforeLock: {\n      [string]: Array<() => void> | null,\n    },\n    cursorComparator: ?CursorComparator,\n    liveConditions: Array<\n      // eslint-disable-next-line flowtype/no-weak-types\n      [(data: {}) => (record: any) => boolean, { [key: string]: SQL } | void]\n    >,\n  };\n  compiledData: {\n    cursorPrefix: Array<string>,\n    select: Array<[SQL, RawAlias]>,\n    selectCursor: ?SQL,\n    from: ?[SQL, SQLAlias],\n    join: Array<SQL>,\n    where: Array<SQL>,\n    whereBound: {\n      lower: Array<SQL>,\n      upper: Array<SQL>,\n    },\n    orderBy: Array<[SQL, boolean, boolean | null]>,\n    orderIsUnique: boolean,\n    limit: ?number,\n    offset: ?number,\n    first: ?number,\n    last: ?number,\n    cursorComparator: ?CursorComparator,\n  };\n\n  constructor(\n    options: QueryBuilderOptions = {},\n    context: GraphQLContext = {},\n    rootValue?: any // eslint-disable-line flowtype/no-weak-types\n  ) {\n    this.context = context || {};\n    this.rootValue = rootValue;\n    this.supportsJSONB =\n      typeof options.supportsJSONB === \"undefined\" ||\n      options.supportsJSONB === null\n        ? true\n        : !!options.supportsJSONB;\n\n    this.locks = {};\n    this.finalized = false;\n    this.selectedIdentifiers = false;\n    this.data = {\n      // TODO: refactor `cursorPrefix`, it shouldn't be here (or should at least have getters/setters)\n      cursorPrefix: [\"natural\"],\n      select: [],\n      selectCursor: null,\n      from: null,\n      join: [],\n      where: [],\n      whereBound: {\n        lower: [],\n        upper: [],\n      },\n      orderBy: [],\n      orderIsUnique: false,\n      limit: null,\n      offset: null,\n      first: null,\n      last: null,\n      beforeLock: {},\n      cursorComparator: null,\n      liveConditions: [],\n    };\n    this.compiledData = {\n      cursorPrefix: [\"natural\"],\n      select: [],\n      selectCursor: null,\n      from: null,\n      join: [],\n      where: [],\n      whereBound: {\n        lower: [],\n        upper: [],\n      },\n      orderBy: [],\n      orderIsUnique: false,\n      limit: null,\n      offset: null,\n      first: null,\n      last: null,\n      cursorComparator: null,\n    };\n    this.beforeLock(\"select\", () => {\n      this.lock(\"selectCursor\");\n      if (this.compiledData.selectCursor) {\n        this.select(this.compiledData.selectCursor, \"__cursor\");\n      }\n    });\n    // 'whereBound' and 'natural' order might set offset/limit\n    this.beforeLock(\"where\", () => {\n      this.lock(\"whereBound\");\n    });\n    this.beforeLock(\"offset\", () => {\n      this.lock(\"whereBound\");\n    });\n    this.beforeLock(\"limit\", () => {\n      this.lock(\"whereBound\");\n    });\n    this.beforeLock(\"first\", () => {\n      this.lock(\"limit\");\n      this.lock(\"offset\");\n    });\n    this.beforeLock(\"last\", () => {\n      this.lock(\"limit\");\n      this.lock(\"offset\");\n    });\n  }\n\n  // ----------------------------------------\n\n  // Helper function\n  jsonbBuildObject(fields: Array<[SQL, RawAlias]>) {\n    if (this.supportsJSONB && fields.length > 50) {\n      const fieldsChunks = chunk(fields, 50);\n      const chunkToJson = fieldsChunk =>\n        sql.fragment`jsonb_build_object(${sql.join(\n          fieldsChunk.map(\n            ([expr, alias]) =>\n              sql.fragment`${sql.literal(alias)}::text, ${expr}`\n          ),\n          \", \"\n        )})`;\n      return sql.fragment`(${sql.join(\n        fieldsChunks.map(chunkToJson),\n        \" || \"\n      )})::json`;\n    } else {\n      // PG9.4 will have issues with more than 100 parameters (50 keys)\n      return sql.fragment`json_build_object(${sql.join(\n        fields.map(\n          ([expr, alias]) => sql.fragment`${sql.literal(alias)}::text, ${expr}`\n        ),\n        \", \"\n      )})`;\n    }\n  }\n\n  // ----------------------------------------\n\n  beforeLock(field: string, fn: () => void) {\n    this.checkLock(field);\n    if (!this.data.beforeLock[field]) {\n      this.data.beforeLock[field] = [];\n    }\n    // $FlowFixMe\n    this.data.beforeLock[field].push(fn);\n  }\n\n  makeLiveCollection(\n    table: PgClass,\n    // eslint-disable-next-line flowtype/no-weak-types\n    cb?: (checker: (data: any) => (record: any) => boolean) => void\n  ) {\n    /* the actual condition doesn't matter hugely, 'select' should work */\n    if (!this.rootValue || !this.rootValue.liveConditions) return;\n    const liveConditions = this.data.liveConditions;\n    const checkerGenerator = data => {\n      // Compute this once.\n      const checkers = liveConditions.map(([checkerGenerator]) =>\n        checkerGenerator(data)\n      );\n      return record => checkers.every(checker => checker(record));\n    };\n    if (this.parentQueryBuilder) {\n      if (cb) {\n        throw new Error(\n          \"Either use parentQueryBuilder or pass callback, not both.\"\n        );\n      }\n      this.parentQueryBuilder.beforeLock(\"select\", () => {\n        const id = this.rootValue.liveConditions.push(checkerGenerator) - 1;\n        // BEWARE: it's easy to override others' conditions, and that will cause issues. Be sensible.\n        const allRequirements = this.data.liveConditions.reduce(\n          (memo, [_checkerGenerator, requirements]) =>\n            requirements ? Object.assign(memo, requirements) : memo,\n          {}\n        );\n        // $FlowFixMe\n        this.parentQueryBuilder.select(\n          sql.fragment`json_build_object(\n          '__id', ${sql.value(id)}::int\n          ${sql.join(\n            Object.keys(allRequirements).map(\n              key =>\n                sql.fragment`, ${sql.literal(key)}::text, ${\n                  allRequirements[key]\n                }`\n            ),\n\n            \", \"\n          )}\n          )`,\n          \"__live\"\n        );\n      });\n    } else if (cb) {\n      cb(checkerGenerator);\n    } else {\n      throw new Error(\n        \"makeLiveCollection was called without parentQueryBuilder and without callback\"\n      );\n    }\n  }\n\n  addLiveCondition(\n    // eslint-disable-next-line flowtype/no-weak-types\n    checkerGenerator: (data: {}) => (record: any) => boolean,\n    requirements?: { [key: string]: SQL }\n  ) {\n    if (requirements && !this.parentQueryBuilder) {\n      throw new Error(\n        \"There's no parentQueryBuilder, so there cannot be requirements\"\n      );\n    }\n    this.data.liveConditions.push([checkerGenerator, requirements]);\n  }\n\n  setCursorComparator(fn: CursorComparator) {\n    this.checkLock(\"cursorComparator\");\n    this.data.cursorComparator = fn;\n    this.lock(\"cursorComparator\");\n  }\n  addCursorCondition(cursorValue: CursorValue, isAfter: boolean) {\n    this.beforeLock(\"whereBound\", () => {\n      this.lock(\"cursorComparator\");\n      if (!this.compiledData.cursorComparator) {\n        throw new Error(\"No cursor comparator was set!\");\n      }\n      this.compiledData.cursorComparator(cursorValue, isAfter);\n    });\n  }\n  select(exprGen: SQLGen, alias: RawAlias) {\n    this.checkLock(\"select\");\n    if (typeof alias === \"string\") {\n      // To protect against vulnerabilities such as\n      //\n      // https://github.com/brianc/node-postgres/issues/1408\n      //\n      // we need to ensure column names are safe. Turns out that GraphQL\n      // aliases are fairly strict (`[_A-Za-z][_0-9A-Za-z]*`) anyway:\n      //\n      // https://github.com/graphql/graphql-js/blob/680685dd14bd52c6475305e150e5f295ead2aa7e/src/language/lexer.js#L551-L581\n      //\n      // so this should not cause any issues in practice.\n      if (/^(\\$+|@+|[_A-Za-z])[_0-9A-Za-z]*$/.test(alias) !== true) {\n        throw new Error(`Disallowed alias '${alias}'.`);\n      }\n    }\n    this.data.select.push([exprGen, alias]);\n  }\n  selectIdentifiers(table: PgClass) {\n    if (this.selectedIdentifiers) return;\n    const primaryKey = table.primaryKeyConstraint;\n    if (!primaryKey) return;\n    const primaryKeys = primaryKey.keyAttributes;\n    this.select(\n      sql.fragment`json_build_array(${sql.join(\n        primaryKeys.map(\n          key =>\n            sql.fragment`${this.getTableAlias()}.${sql.identifier(key.name)}`\n        ),\n        \", \"\n      )})`,\n      \"__identifiers\"\n    );\n    this.selectedIdentifiers = true;\n  }\n  selectCursor(exprGen: SQLGen) {\n    this.checkLock(\"selectCursor\");\n    this.data.selectCursor = exprGen;\n  }\n  from(expr: SQLGen, alias?: SQLAlias = sql.identifier(Symbol())) {\n    this.checkLock(\"from\");\n    if (!expr) {\n      throw new Error(\"No from table source!\");\n    }\n    if (!alias) {\n      throw new Error(\"No from alias!\");\n    }\n    this.data.from = [expr, alias];\n    this.lock(\"from\");\n  }\n  // XXX: join\n  where(exprGen: SQLGen) {\n    this.checkLock(\"where\");\n    this.data.where.push(exprGen);\n  }\n  whereBound(exprGen: SQLGen, isLower: boolean) {\n    if (typeof isLower !== \"boolean\") {\n      throw new Error(\"isLower must be specified as a boolean\");\n    }\n    this.checkLock(\"whereBound\");\n    this.data.whereBound[isLower ? \"lower\" : \"upper\"].push(exprGen);\n  }\n  setOrderIsUnique() {\n    this.data.orderIsUnique = true;\n  }\n  orderBy(\n    exprGen: SQLGen,\n    ascending: boolean = true,\n    nullsFirst: boolean | null\n  ) {\n    this.checkLock(\"orderBy\");\n    this.data.orderBy.push([exprGen, ascending, nullsFirst]);\n  }\n  limit(limitGen: NumberGen) {\n    this.checkLock(\"limit\");\n\n    if (this.data.limit != null) {\n      throw new Error(\"Must only set limit once\");\n    }\n    this.data.limit = limitGen;\n  }\n  offset(offsetGen: NumberGen) {\n    this.checkLock(\"offset\");\n    if (this.data.offset != null) {\n      // Add the offsets together (this should be able to recurse)\n      const previous = this.data.offset;\n      this.data.offset = context => {\n        return (\n          callIfNecessary(previous, context) +\n          callIfNecessary(offsetGen, context)\n        );\n      };\n    } else {\n      this.data.offset = offsetGen;\n    }\n  }\n  first(first: number) {\n    this.checkLock(\"first\");\n    if (this.data.first != null) {\n      throw new Error(\"Must only set first once\");\n    }\n    this.data.first = first;\n  }\n  last(last: number) {\n    this.checkLock(\"last\");\n    if (this.data.last != null) {\n      throw new Error(\"Must only set last once\");\n    }\n    this.data.last = last;\n  }\n\n  // ----------------------------------------\n\n  isOrderUnique(lock?: boolean = true) {\n    if (lock) {\n      this.lock(\"orderBy\");\n      this.lock(\"orderIsUnique\");\n      return this.compiledData.orderIsUnique;\n    } else {\n      // This is useful inside `beforeLock(\"orderBy\", ...)` calls\n      return this.data.orderIsUnique;\n    }\n  }\n  getTableExpression(): SQL {\n    this.lock(\"from\");\n    if (!this.compiledData.from) {\n      throw new Error(\"No from table has been supplied\");\n    }\n    return this.compiledData.from[0];\n  }\n  getTableAlias(): SQL {\n    this.lock(\"from\");\n    if (!this.compiledData.from) {\n      throw new Error(\"No from table has been supplied\");\n    }\n    return this.compiledData.from[1];\n  }\n  getSelectCursor() {\n    this.lock(\"selectCursor\");\n    return this.compiledData.selectCursor;\n  }\n  getOffset() {\n    this.lock(\"offset\");\n    return this.compiledData.offset || 0;\n  }\n  getFinalLimitAndOffset() {\n    this.lock(\"offset\");\n    this.lock(\"limit\");\n    this.lock(\"first\");\n    this.lock(\"last\");\n    let limit = this.compiledData.limit;\n    let offset = this.compiledData.offset || 0;\n    let flip = false;\n    if (this.compiledData.first != null) {\n      if (limit != null) {\n        limit = Math.min(limit, this.compiledData.first);\n      } else {\n        limit = this.compiledData.first;\n      }\n    }\n    if (this.compiledData.last != null) {\n      if (offset > 0 && limit != null) {\n        throw new Error(\n          \"Issue within pagination, please report your query to graphile-build\"\n        );\n      }\n      if (limit != null) {\n        if (this.compiledData.last < limit) {\n          offset = limit - this.compiledData.last;\n          limit = this.compiledData.last;\n        } else {\n          // no need to change anything\n        }\n      } else if (offset > 0) {\n        throw new Error(\"Cannot combine 'last' and 'offset'\");\n      } else {\n        if (this.compiledData.orderBy.length > 0) {\n          flip = true;\n          limit = this.compiledData.last;\n        } else {\n          throw new Error(\"Cannot do last of an unordered set\");\n        }\n      }\n    }\n    return {\n      limit,\n      offset,\n      flip,\n    };\n  }\n  getFinalOffset() {\n    return this.getFinalLimitAndOffset().offset;\n  }\n  getFinalLimit() {\n    return this.getFinalLimitAndOffset().limit;\n  }\n  getOrderByExpressionsAndDirections() {\n    this.lock(\"orderBy\");\n    return this.compiledData.orderBy;\n  }\n  getSelectFieldsCount() {\n    this.lockEverything();\n    return this.compiledData.select.length;\n  }\n  buildSelectFields() {\n    this.lockEverything();\n    return sql.join(\n      this.compiledData.select.map(\n        ([sqlFragment, alias]) =>\n          sql.fragment`to_json(${sqlFragment}) as ${sql.identifier(alias)}`\n      ),\n      \", \"\n    );\n  }\n  buildSelectJson({ addNullCase }: { addNullCase?: boolean }) {\n    this.lockEverything();\n    let buildObject = this.compiledData.select.length\n      ? this.jsonbBuildObject(this.compiledData.select)\n      : sql.fragment`to_json(${this.getTableAlias()})`;\n    if (addNullCase) {\n      buildObject = sql.fragment`(case when (${this.getTableAlias()} is null) then null else ${buildObject} end)`;\n    }\n    return buildObject;\n  }\n  buildWhereBoundClause(isLower: boolean) {\n    this.lock(\"whereBound\");\n    const clauses = this.compiledData.whereBound[isLower ? \"lower\" : \"upper\"];\n    if (clauses.length) {\n      return sql.fragment`(${sql.join(clauses, \") and (\")})`;\n    } else {\n      return sql.literal(true);\n    }\n  }\n  buildWhereClause(\n    includeLowerBound: boolean,\n    includeUpperBound: boolean,\n    { addNullCase }: { addNullCase?: boolean }\n  ) {\n    this.lock(\"where\");\n    const clauses = [\n      ...(addNullCase\n        ? /*\n           * Okay... so this is quite interesting. When we're talking about\n           * composite types, `(foo is not null)` and `not (foo is null)` are\n           * NOT equivalent! Here's why:\n           *\n           * `(foo is null)`\n           *   true if every field of the row is null\n           *\n           * `(foo is not null)`\n           *   true if every field of the row is not null\n           *\n           * `not (foo is null)`\n           *   true if there's at least one field that is not null\n           *\n           * So don't \"simplify\" the line below! We're probably checking if\n           * the result of a function call returning a compound type was\n           * indeed null.\n           */\n          [sql.fragment`not (${this.getTableAlias()} is null)`]\n        : []),\n      ...this.compiledData.where,\n      ...(includeLowerBound ? [this.buildWhereBoundClause(true)] : []),\n      ...(includeUpperBound ? [this.buildWhereBoundClause(false)] : []),\n    ];\n    return clauses.length\n      ? sql.fragment`(${sql.join(clauses, \") and (\")})`\n      : sql.fragment`1 = 1`;\n  }\n  build(\n    options: {\n      asJson?: boolean,\n      asJsonAggregate?: boolean,\n      onlyJsonField?: boolean,\n      addNullCase?: boolean,\n      useAsterisk?: boolean,\n    } = {}\n  ) {\n    const {\n      asJson = false,\n      asJsonAggregate = false,\n      onlyJsonField = false,\n      addNullCase = false,\n      useAsterisk = false,\n    } = options;\n\n    this.lockEverything();\n    if (onlyJsonField) {\n      return this.buildSelectJson({ addNullCase });\n    }\n    const { limit, offset, flip } = this.getFinalLimitAndOffset();\n    const fields =\n      asJson || asJsonAggregate\n        ? sql.fragment`${this.buildSelectJson({ addNullCase })} as object`\n        : this.buildSelectFields();\n\n    let fragment = sql.fragment`\n      select ${useAsterisk ? sql.fragment`${this.getTableAlias()}.*` : fields}\n      ${this.compiledData.from &&\n        sql.fragment`from ${\n          this.compiledData.from[0]\n        } as ${this.getTableAlias()}`}\n      ${this.compiledData.join.length && sql.join(this.compiledData.join, \" \")}\n      where ${this.buildWhereClause(true, true, options)}\n      ${\n        this.compiledData.orderBy.length\n          ? sql.fragment`order by ${sql.join(\n              this.compiledData.orderBy.map(\n                ([expr, ascending, nullsFirst]) =>\n                  sql.fragment`${expr} ${\n                    Number(ascending) ^ Number(flip)\n                      ? sql.fragment`ASC`\n                      : sql.fragment`DESC`\n                  }${\n                    nullsFirst === true\n                      ? sql.fragment` NULLS FIRST`\n                      : nullsFirst === false\n                        ? sql.fragment` NULLS LAST`\n                        : null\n                  }`\n              ),\n              \",\"\n            )}`\n          : \"\"\n      }\n      ${isSafeInteger(limit) && sql.fragment`limit ${sql.literal(limit)}`}\n      ${offset && sql.fragment`offset ${sql.literal(offset)}`}\n    `;\n    if (flip) {\n      const flipAlias = Symbol();\n      fragment = sql.fragment`\n        with ${sql.identifier(flipAlias)} as (\n          ${fragment}\n        )\n        select *\n        from ${sql.identifier(flipAlias)}\n        order by (row_number() over (partition by 1)) desc\n        `;\n    }\n    if (useAsterisk) {\n      fragment = sql.fragment`select ${fields} from (${fragment}) ${this.getTableAlias()}`;\n    }\n    if (asJsonAggregate) {\n      const aggAlias = Symbol();\n      fragment = sql.fragment`select json_agg(${sql.identifier(\n        aggAlias,\n        \"object\"\n      )}) from (${fragment}) as ${sql.identifier(aggAlias)}`;\n      fragment = sql.fragment`select coalesce((${fragment}), '[]'::json)`;\n    }\n    return fragment;\n  }\n\n  // ----------------------------------------\n\n  _finalize() {\n    this.finalized = true;\n  }\n  lock(type: string) {\n    if (this.locks[type]) return;\n    const getContext = () => ({\n      queryBuilder: this,\n    });\n    const beforeLocks = this.data.beforeLock[type];\n    if (beforeLocks && beforeLocks.length) {\n      this.data.beforeLock[type] = null;\n      for (const fn of beforeLocks) {\n        fn();\n      }\n    }\n    if (type !== \"select\") {\n      this.locks[type] = isDev ? new Error(\"Initally locked here\").stack : true;\n    }\n    if (type === \"cursorComparator\") {\n      // It's meant to be a function\n      this.compiledData[type] = this.data[type];\n    } else if (type === \"whereBound\") {\n      // Handle properties separately\n      const context = getContext();\n      this.compiledData[type].lower = callIfNecessaryArray(\n        this.data[type].lower,\n        context\n      );\n      this.compiledData[type].upper = callIfNecessaryArray(\n        this.data[type].upper,\n        context\n      );\n    } else if (type === \"select\") {\n      /*\n       * NOTICE: locking select can cause additional selects to be added, so the\n       * length of this.data[type] may increase during the operation. This is\n       * why we handle this.locks[type] separately.\n       */\n\n      // Assume that duplicate fields must be identical, don't output the same\n      // key multiple times\n      const seenFields = {};\n      const context = getContext();\n      const data = [];\n      const selects = this.data[type];\n\n      // DELIBERATE slow loop, see NOTICE above\n      for (let i = 0; i < selects.length; i++) {\n        const [valueOrGenerator, columnName] = selects[i];\n        // $FlowFixMe\n        if (!seenFields[columnName]) {\n          // $FlowFixMe\n          seenFields[columnName] = true;\n          data.push([callIfNecessary(valueOrGenerator, context), columnName]);\n          const newBeforeLocks = this.data.beforeLock[type];\n          if (newBeforeLocks && newBeforeLocks.length) {\n            this.data.beforeLock[type] = null;\n            for (const fn of newBeforeLocks) {\n              fn();\n            }\n          }\n        }\n      }\n      this.locks[type] = isDev ? new Error(\"Initally locked here\").stack : true;\n      this.compiledData[type] = data;\n    } else if (type === \"orderBy\") {\n      const context = getContext();\n      this.compiledData[type] = this.data[type].map(([a, b, c]) => [\n        callIfNecessary(a, context),\n        b,\n        c,\n      ]);\n    } else if (type === \"from\") {\n      if (this.data.from) {\n        const f = this.data.from;\n        const context = getContext();\n        this.compiledData.from = [callIfNecessary(f[0], context), f[1]];\n      }\n    } else if (type === \"join\" || type === \"where\") {\n      const context = getContext();\n      this.compiledData[type] = callIfNecessaryArray(this.data[type], context);\n    } else if (type === \"selectCursor\") {\n      const context = getContext();\n      this.compiledData[type] = callIfNecessary(this.data[type], context);\n    } else if (type === \"cursorPrefix\") {\n      this.compiledData[type] = this.data[type];\n    } else if (type === \"orderIsUnique\") {\n      this.compiledData[type] = this.data[type];\n    } else if (type === \"limit\") {\n      const context = getContext();\n      this.compiledData[type] = callIfNecessary(this.data[type], context);\n    } else if (type === \"offset\") {\n      const context = getContext();\n      this.compiledData[type] = callIfNecessary(this.data[type], context);\n    } else if (type === \"first\") {\n      this.compiledData[type] = this.data[type];\n    } else if (type === \"last\") {\n      this.compiledData[type] = this.data[type];\n    } else {\n      throw new Error(`Wasn't expecting to lock '${type}'`);\n    }\n  }\n  checkLock(type: string) {\n    if (this.locks[type]) {\n      if (typeof this.locks[type] === \"string\") {\n        throw new Error(\n          `'${type}' has already been locked\\n    ` +\n            this.locks[type].replace(/\\n/g, \"\\n    \") +\n            \"\\n\"\n        );\n      }\n      throw new Error(`'${type}' has already been locked`);\n    }\n  }\n  lockEverything() {\n    this._finalize();\n    // We must execute everything after `from` so we have the alias to reference\n    this.lock(\"from\");\n    this.lock(\"join\");\n    this.lock(\"orderBy\");\n    // We must execute where after orderBy because cursor queries require all orderBy columns\n    this.lock(\"cursorComparator\");\n    this.lock(\"whereBound\");\n    this.lock(\"where\");\n    // 'where' -> 'whereBound' can affect 'offset'/'limit'\n    this.lock(\"offset\");\n    this.lock(\"limit\");\n    this.lock(\"first\");\n    this.lock(\"last\");\n    // We must execute select after orderBy otherwise we cannot generate a cursor\n    this.lock(\"selectCursor\");\n    this.lock(\"select\");\n  }\n}\n\nexport default QueryBuilder;\n"]}