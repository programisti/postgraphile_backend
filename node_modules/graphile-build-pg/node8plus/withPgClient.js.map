{"version":3,"sources":["../src/withPgClient.js"],"names":["quacksLikePgPool","debug","constructorName","obj","constructor","name","quacksLikePgClient","pgConfig","connect","end","escapeLiteral","escapeIdentifier","Client","options","query","getPgClientAndReleaserFromConfig","process","env","DATABASE_URL","releasePgClient","pgClient","pg","release","Error","Pool","pgPool","undefined","on","e","Promise","resolve","reject","err","withPgClient","fn","errorHandler","console","error","message","removeListener"],"mappings":";;;;;;QAuBgBA,gB,GAAAA,gB;;AAtBhB;;;;AACA;;;;;;AAEA,MAAMC,QAAQ,qBAAa,mBAAb,CAAd;;AAEA,SAASC,eAAT,CAAyBC,GAAzB,EAA8B;AAC5B,SAAOA,OAAO,OAAOA,IAAIC,WAAX,KAA2B,UAAlC,IAAgDD,IAAIC,WAAJ,CAAgBC,IAAvE;AACD;;AAED;;AAEA,SAASC,kBAAT,CAA4BC,QAA5B,EAAsD;AACpD;AACA,MAAI,CAACA,QAAD,IAAa,OAAOA,QAAP,KAAoB,QAArC,EAA+C,OAAO,KAAP;AAC/C,MAAIL,gBAAgBK,QAAhB,MAA8B,QAAlC,EAA4C,OAAO,KAAP;AAC5C,MAAI,OAAOA,SAASC,OAAhB,KAA4B,UAAhC,EAA4C,OAAO,KAAP;AAC5C,MAAI,OAAOD,SAASE,GAAhB,KAAwB,UAA5B,EAAwC,OAAO,KAAP;AACxC,MAAI,OAAOF,SAASG,aAAhB,KAAkC,UAAtC,EAAkD,OAAO,KAAP;AAClD,MAAI,OAAOH,SAASI,gBAAhB,KAAqC,UAAzC,EAAqD,OAAO,KAAP;AACrD,SAAO,IAAP;AACD;;AAEM,SAASX,gBAAT,CAA0BO,QAA1B,EAAoD;AACzD;AACA,MAAI,CAACA,QAAD,IAAa,OAAOA,QAAP,KAAoB,QAArC,EAA+C,OAAO,KAAP;AAC/C,MACEL,gBAAgBK,QAAhB,MAA8B,MAA9B,IACAL,gBAAgBK,QAAhB,MAA8B,WAFhC,EAGE;AACA,WAAO,KAAP;AACD;AACD,MAAI,CAACA,SAASK,MAAd,EAAsB,OAAO,KAAP;AACtB,MAAI,CAACL,SAASM,OAAd,EAAuB,OAAO,KAAP;AACvB,MAAI,OAAON,SAASC,OAAhB,KAA4B,UAAhC,EAA4C,OAAO,KAAP;AAC5C,MAAI,OAAOD,SAASE,GAAhB,KAAwB,UAA5B,EAAwC,OAAO,KAAP;AACxC,MAAI,OAAOF,SAASO,KAAhB,KAA0B,UAA9B,EAA0C,OAAO,KAAP;AAC1C,SAAO,IAAP;AACD;;AAEM,MAAMC,8EAAmC,OAC9CR,WAAyCS,QAAQC,GAAR,CAAYC,YADP,KAE3C;AACH,MAAIC,kBAAkB,MAAM,CAAE,CAA9B;AACA,MAAIC,QAAJ;AACA,MAAIb,oBAAoBc,aAAGT,MAAvB,IAAiCN,mBAAmBC,QAAnB,CAArC,EAAmE;AACjEa,eAAYb,QAAZ;AACA,QAAI,CAACa,SAASE,OAAd,EAAuB;AACrB,YAAM,IAAIC,KAAJ,CACJ,sJADI,CAAN;AAGD;AACF,GAPD,MAOO,IAAIhB,oBAAoBc,aAAGG,IAAvB,IAA+BxB,iBAAiBO,QAAjB,CAAnC,EAA+D;AACpE,UAAMkB,SAAUlB,QAAhB;AACAa,eAAW,MAAMK,OAAOjB,OAAP,EAAjB;AACAW,sBAAkB,MAAMC,SAASE,OAAT,EAAxB;AACD,GAJM,MAIA,IAAIf,aAAamB,SAAb,IAA0B,OAAOnB,QAAP,KAAoB,QAAlD,EAA4D;AACjEa,eAAW,IAAIC,aAAGT,MAAP,CAAcL,QAAd,CAAX;AACAa,aAASO,EAAT,CAAY,OAAZ,EAAqBC,KAAK;AACxB3B,YAAM,6BAAN,EAAqC2B,CAArC;AACD,KAFD;AAGAT,sBAAkB,MAChB,IAAIU,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KACVX,SAASX,GAAT,CAAauB,OAAQA,MAAMD,OAAOC,GAAP,CAAN,GAAoBF,SAAzC,CADF,CADF;AAIA,UAAM,IAAID,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAChBX,SAASZ,OAAT,CAAiBwB,OAAQA,MAAMD,OAAOC,GAAP,CAAN,GAAoBF,SAA7C,CADI,CAAN;AAGD,GAZM,MAYA;AACL,UAAM,IAAIP,KAAJ,CACJ,4FADI,CAAN;AAGD;AACD,SAAO,EAAEH,QAAF,EAAYD,eAAZ,EAAP;AACD,CAlCM;;AAoCP,MAAMc,eAAe,OACnB1B,QADmB,EAEnB2B,EAFmB,KAGhB;AACH,MAAI,CAACA,EAAL,EAAS;AACP,UAAM,IAAIX,KAAJ,CAAU,gBAAV,CAAN;AACD;AACD,QAAM,EAAEH,QAAF,EAAYD,eAAZ,KAAgC,MAAMJ,iCAC1CR,QAD0C,CAA5C;AAGA,QAAM4B,eAAeP,KAAK;AACxB;AACAQ,YAAQC,KAAR,CAAc,4BAAd,EAA4CT,EAAEU,OAA9C;AACD,GAHD;AAIAlB,WAASO,EAAT,CAAY,OAAZ,EAAqBQ,YAArB;AACA,MAAI;AACF,WAAO,MAAMD,GAAGd,QAAH,CAAb;AACD,GAFD,SAEU;AACRA,aAASmB,cAAT,CAAwB,OAAxB,EAAiCJ,YAAjC;AACA,QAAI;AACF,YAAMhB,iBAAN;AACD,KAFD,CAEE,OAAOS,CAAP,EAAU;AACV;AACD;AACF;AACF,CAzBD;;kBA2BeK,Y","file":"withPgClient.js","sourcesContent":["// @flow\nimport pg from \"pg\";\nimport debugFactory from \"debug\";\n\nconst debug = debugFactory(\"graphile-build-pg\");\n\nfunction constructorName(obj) {\n  return obj && typeof obj.constructor === \"function\" && obj.constructor.name;\n}\n\n// Some duck-typing\n\nfunction quacksLikePgClient(pgConfig: mixed): boolean {\n  // A diagnosis of exclusion\n  if (!pgConfig || typeof pgConfig !== \"object\") return false;\n  if (constructorName(pgConfig) !== \"Client\") return false;\n  if (typeof pgConfig.connect !== \"function\") return false;\n  if (typeof pgConfig.end !== \"function\") return false;\n  if (typeof pgConfig.escapeLiteral !== \"function\") return false;\n  if (typeof pgConfig.escapeIdentifier !== \"function\") return false;\n  return true;\n}\n\nexport function quacksLikePgPool(pgConfig: mixed): boolean {\n  // A diagnosis of exclusion\n  if (!pgConfig || typeof pgConfig !== \"object\") return false;\n  if (\n    constructorName(pgConfig) !== \"Pool\" &&\n    constructorName(pgConfig) !== \"BoundPool\"\n  ) {\n    return false;\n  }\n  if (!pgConfig.Client) return false;\n  if (!pgConfig.options) return false;\n  if (typeof pgConfig.connect !== \"function\") return false;\n  if (typeof pgConfig.end !== \"function\") return false;\n  if (typeof pgConfig.query !== \"function\") return false;\n  return true;\n}\n\nexport const getPgClientAndReleaserFromConfig = async (\n  pgConfig: pg.Client | pg.Pool | string = process.env.DATABASE_URL\n) => {\n  let releasePgClient = () => {};\n  let pgClient: pg.Client;\n  if (pgConfig instanceof pg.Client || quacksLikePgClient(pgConfig)) {\n    pgClient = (pgConfig: pg.Client);\n    if (!pgClient.release) {\n      throw new Error(\n        \"We only support PG clients from a PG pool (because otherwise the `await` call can hang indefinitely if an error occurs and there's no error handler)\"\n      );\n    }\n  } else if (pgConfig instanceof pg.Pool || quacksLikePgPool(pgConfig)) {\n    const pgPool = (pgConfig: pg.Pool);\n    pgClient = await pgPool.connect();\n    releasePgClient = () => pgClient.release();\n  } else if (pgConfig === undefined || typeof pgConfig === \"string\") {\n    pgClient = new pg.Client(pgConfig);\n    pgClient.on(\"error\", e => {\n      debug(\"pgClient error occurred: %s\", e);\n    });\n    releasePgClient = () =>\n      new Promise((resolve, reject) =>\n        pgClient.end(err => (err ? reject(err) : resolve()))\n      );\n    await new Promise((resolve, reject) =>\n      pgClient.connect(err => (err ? reject(err) : resolve()))\n    );\n  } else {\n    throw new Error(\n      \"You must provide either a pg.Pool or pg.Client instance or a PostgreSQL connection string.\"\n    );\n  }\n  return { pgClient, releasePgClient };\n};\n\nconst withPgClient = async (\n  pgConfig: pg.Client | pg.Pool | string | void,\n  fn: (pgClient: pg.Client) => *\n) => {\n  if (!fn) {\n    throw new Error(\"Nothing to do!\");\n  }\n  const { pgClient, releasePgClient } = await getPgClientAndReleaserFromConfig(\n    pgConfig\n  );\n  const errorHandler = e => {\n    // eslint-disable-next-line no-console\n    console.error(\"withPgClient client error:\", e.message);\n  };\n  pgClient.on(\"error\", errorHandler);\n  try {\n    return await fn(pgClient);\n  } finally {\n    pgClient.removeListener(\"error\", errorHandler);\n    try {\n      await releasePgClient();\n    } catch (e) {\n      // Failed to release, assuming success\n    }\n  }\n};\n\nexport default withPgClient;\n"]}